{"version":3,"sources":["../src/queues/render.queue.ts","../src/config.ts","../src/events.ts"],"sourcesContent":["import { Queue, Worker, QueueEvents, Job, ConnectionOptions } from 'bullmq';\nimport { RenderJobData, RenderJobResult } from '../types';\nimport { QUEUE_NAMES, QUEUE_PRIORITIES, defaultQueueOptions } from '../config';\n\nlet renderQueue: Queue<RenderJobData, RenderJobResult> | null = null;\nlet renderQueueEvents: QueueEvents | null = null;\n\nexport function getRenderQueue(\n  connection?: ConnectionOptions\n): Queue<RenderJobData, RenderJobResult> {\n  if (!renderQueue) {\n    renderQueue = new Queue<RenderJobData, RenderJobResult>(QUEUE_NAMES.RENDER, {\n      ...defaultQueueOptions,\n      ...(connection && { connection }),\n    });\n  }\n  return renderQueue;\n}\n\nexport function getRenderQueueEvents(connection?: ConnectionOptions): QueueEvents {\n  if (!renderQueueEvents) {\n    renderQueueEvents = new QueueEvents(QUEUE_NAMES.RENDER, {\n      connection: connection || defaultQueueOptions.connection,\n    });\n  }\n  return renderQueueEvents;\n}\n\nexport async function addRenderJob(\n  data: RenderJobData,\n  options?: {\n    priority?: number;\n    delay?: number;\n  }\n): Promise<Job<RenderJobData, RenderJobResult>> {\n  const queue = getRenderQueue();\n\n  // Set priority based on subscription tier\n  const priority =\n    options?.priority ??\n    QUEUE_PRIORITIES[data.subscriptionTier.toUpperCase() as keyof typeof QUEUE_PRIORITIES];\n\n  return queue.add('render', data, {\n    priority,\n    delay: options?.delay,\n  });\n}\n\nexport function createRenderWorker(\n  processFunction: (job: Job<RenderJobData>) => Promise<RenderJobResult>,\n  connection?: ConnectionOptions,\n  concurrency = 5\n): Worker<RenderJobData, RenderJobResult> {\n  return new Worker<RenderJobData, RenderJobResult>(QUEUE_NAMES.RENDER, processFunction, {\n    connection: connection || defaultQueueOptions.connection,\n    concurrency,\n    autorun: true,\n  });\n}\n\n// Rate limiting helpers\nexport async function getRenderJobCount(userId: string, windowMs = 60000): Promise<number> {\n  const queue = getRenderQueue();\n  const jobs = await queue.getJobs(['active', 'waiting', 'delayed']);\n  const cutoff = Date.now() - windowMs;\n\n  return jobs.filter((job) => job.data.userId === userId && (job.timestamp || 0) > cutoff).length;\n}\n\nexport async function canUserSubmitRender(\n  userId: string,\n  subscriptionTier: 'starter' | 'pro' | 'growth'\n): Promise<{ allowed: boolean; reason?: string }> {\n  const limits = {\n    starter: { perMinute: 2, perHour: 20 },\n    pro: { perMinute: 10, perHour: 100 },\n    growth: { perMinute: 20, perHour: 300 },\n  };\n\n  const limit = limits[subscriptionTier];\n  const minuteCount = await getRenderJobCount(userId, 60000);\n  const hourCount = await getRenderJobCount(userId, 3600000);\n\n  if (minuteCount >= limit.perMinute) {\n    return {\n      allowed: false,\n      reason: `Rate limit exceeded: ${limit.perMinute} renders per minute`,\n    };\n  }\n\n  if (hourCount >= limit.perHour) {\n    return {\n      allowed: false,\n      reason: `Rate limit exceeded: ${limit.perHour} renders per hour`,\n    };\n  }\n\n  return { allowed: true };\n}\n\n// Queue metrics\nexport async function getQueueMetrics() {\n  const queue = getRenderQueue();\n\n  const [waiting, active, completed, failed, delayed] = await Promise.all([\n    queue.getWaitingCount(),\n    queue.getActiveCount(),\n    queue.getCompletedCount(),\n    queue.getFailedCount(),\n    queue.getDelayedCount(),\n  ]);\n\n  // BullMQ doesn't have getPausedCount in newer versions\n  const paused = 0;\n\n  return {\n    waiting,\n    active,\n    completed,\n    failed,\n    delayed,\n    paused,\n    total: waiting + active + delayed + paused,\n  };\n}\n\n// Cleanup on shutdown\nexport async function closeRenderQueue() {\n  if (renderQueue) {\n    await renderQueue.close();\n    renderQueue = null;\n  }\n  if (renderQueueEvents) {\n    await renderQueueEvents.close();\n    renderQueueEvents = null;\n  }\n}\n","import { ConnectionOptions, QueueOptions } from 'bullmq';\n\n// Parse Upstash Redis URL if provided\nfunction getRedisConnection(): ConnectionOptions {\n  const redisHost = process.env.REDIS_HOST;\n\n  // If REDIS_HOST is a URL (Upstash format)\n  if (redisHost && redisHost.startsWith('https://')) {\n    const url = new URL(redisHost);\n    return {\n      host: url.hostname,\n      port: parseInt(process.env.REDIS_PORT || '6379'),\n      password: process.env.REDIS_PASSWORD,\n      tls: {},\n      maxRetriesPerRequest: null,\n    };\n  }\n\n  // Standard Redis connection\n  return {\n    host: redisHost || 'localhost',\n    port: parseInt(process.env.REDIS_PORT || '6379'),\n    password: process.env.REDIS_PASSWORD,\n    maxRetriesPerRequest: null,\n  };\n}\n\nexport const redisConnection: ConnectionOptions = getRedisConnection();\n\nexport const defaultQueueOptions: QueueOptions = {\n  connection: redisConnection,\n  defaultJobOptions: {\n    attempts: 3,\n    backoff: {\n      type: 'exponential',\n      delay: 1000,\n    },\n    removeOnComplete: {\n      age: 3600, // 1 hour\n      count: 100,\n    },\n    removeOnFail: {\n      age: 24 * 3600, // 24 hours\n    },\n  },\n};\n\nexport const QUEUE_NAMES = {\n  RENDER: 'renderQueue',\n  NOTIFICATION: 'notificationQueue',\n} as const;\n\nexport const QUEUE_PRIORITIES = {\n  STARTER: 5,\n  PRO: 3,\n  GROWTH: 1,\n} as const;\n","import { EventEmitter } from 'events';\nimport { QueueEvents } from 'bullmq';\nimport { getRenderQueueEvents } from './queues/render.queue';\n\nexport interface RenderQueueEventData {\n  progress: { jobId: string; progress: number };\n  completed: { jobId: string; result: any };\n  failed: { jobId: string; error: Error };\n}\n\nclass QueueEventEmitter extends EventEmitter {\n  private queueEvents!: QueueEvents;\n  private initialized = false;\n\n  constructor() {\n    super();\n    this.setMaxListeners(100); // Allow many SSE connections\n  }\n\n  initialize() {\n    if (this.initialized) return;\n\n    this.queueEvents = getRenderQueueEvents();\n\n    // Set up queue event listeners\n    this.queueEvents.on('progress', (data) => {\n      this.emit('progress', {\n        jobId: data.jobId,\n        progress: data.data,\n      });\n    });\n\n    this.queueEvents.on('completed', (data) => {\n      this.emit('completed', {\n        jobId: data.jobId,\n        result: data.returnvalue,\n      });\n    });\n\n    this.queueEvents.on('failed', (data) => {\n      this.emit('failed', {\n        jobId: data.jobId,\n        error: new Error(data.failedReason || 'Job failed'),\n      });\n    });\n\n    this.initialized = true;\n  }\n\n  async close() {\n    if (this.queueEvents) {\n      await this.queueEvents.close();\n    }\n    this.removeAllListeners();\n  }\n}\n\n// Singleton instance\nlet queueEventEmitter: QueueEventEmitter | null = null;\n\nexport function getQueueEventEmitter(): QueueEventEmitter {\n  if (!queueEventEmitter) {\n    queueEventEmitter = new QueueEventEmitter();\n    queueEventEmitter.initialize();\n  }\n  return queueEventEmitter;\n}\n\nexport { getRenderQueueEvents };\n"],"mappings":"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","names":[]}